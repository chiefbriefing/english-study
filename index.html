<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì˜ë¬¸ ë¶„ì„ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--pri:#4f46e5;--pri-l:#eef2ff;--acc:#6366f1;--red:#e11d48;--grn:#059669;--amb:#b45309;--pur:#7c3aed;
--tx:#1e293b;--tx2:#475569;--tx3:#94a3b8;--bg:linear-gradient(160deg,#f8fafc 0%,#eef2ff 40%,#faf5ff 100%);
--card:#fff;--bd:#f1f5f9;--bd2:#e2e8f0;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',-apple-system,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;}
.nf{font-family:'Newsreader',Georgia,serif;}
.flex{display:flex;}.fc{flex-direction:column;}.ai{align-items:center;}.jc{justify-content:center;}.jb{justify-content:space-between;}.fw{flex-wrap:wrap;}
.g1{gap:4px;}.g2{gap:8px;}.g3{gap:12px;}.tc{text-align:center;}.w100{width:100%;}
.hdr{background:rgba(255,255,255,0.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--bd2);padding:10px 16px;position:sticky;top:0;z-index:100;}
.btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;border:1.5px solid transparent;transition:all .15s;}
.btn:hover{filter:brightness(.95);}.bp{background:var(--pri);color:#fff;border-color:var(--pri);}.bo{background:var(--pri-l);color:var(--pri);border-color:rgba(79,70,229,.2);}
.ba{background:#fef3c7;color:#92400e;border-color:rgba(245,158,11,.3);}.bg-btn{background:#d1fae5;color:var(--grn);border-color:rgba(16,185,129,.3);}
.br{background:#fee2e2;color:#dc2626;border-color:rgba(239,68,68,.3);}
.bbig{padding:14px 40px;border-radius:12px;font-size:16px;font-weight:700;background:linear-gradient(135deg,#6366f1,#4f46e5);color:#fff;border:none;box-shadow:0 4px 14px rgba(99,102,241,.35);cursor:pointer;}
.bbig:disabled{background:#cbd5e1;box-shadow:none;cursor:default;}
.card{background:var(--card);border-radius:14px;border:1px solid var(--bd);box-shadow:0 1px 3px rgba(0,0,0,.03);overflow:hidden;}
.sh{padding:14px 18px;cursor:pointer;user-select:none;}.sb{padding:0 18px 16px 18px;}
input[type="text"]{padding:12px 16px;border-radius:12px;border:2px solid var(--bd2);font-size:14px;outline:none;width:100%;box-sizing:border-box;transition:border .2s;}
input[type="text"]:focus{border-color:var(--acc);}
textarea{padding:12px 16px;border-radius:12px;border:2px solid var(--bd2);font-size:15px;outline:none;width:100%;box-sizing:border-box;transition:border .2s;font-family:'Newsreader',Georgia,serif;line-height:1.9;resize:vertical;min-height:220px;}
textarea:focus{border-color:var(--acc);}
.tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px;white-space:nowrap;}
.tp{background:var(--acc);color:#fff;font-weight:800;}.ts{background:var(--pri-l);color:var(--acc);font-weight:800;}
.tt{background:#d1fae5;color:var(--grn);font-weight:600;}.tr{background:var(--pri-l);color:var(--acc);font-weight:600;border-radius:14px;padding:2px 9px;}
.chip{font-size:10.5px;font-weight:700;padding:2px 9px;border-radius:20px;white-space:nowrap;}
.sent{cursor:pointer;font-size:16px;padding:1px 3px;border-bottom:2px solid transparent;border-radius:0;transition:all .12s;}
.sent:hover{background:#f8fafc;border-bottom-color:#c7d2fe;border-radius:4px;}
.sent.act{color:var(--pri);font-weight:600;background:var(--pri-l);border-bottom-color:var(--acc);border-radius:4px;}
.dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--acc);position:relative;top:-6px;margin-left:-3px;}
.cn{padding:3px 12px 3px 20px;background:#fef2f2;border-left:3px solid #fca5a5;font-size:11.5px;color:#b91c1c;font-weight:500;}
.fb{background:#fef2f2;border-radius:10px;padding:12px 16px;border:1px solid rgba(254,202,202,.25);}
.tb{background:#f8fafc;border-radius:8px;padding:10px 14px;}
.cc{background:#fffbeb;border:1.5px solid #fde68a;border-left:4px solid #f59e0b;border-radius:10px;padding:12px 14px;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--tx);color:#fff;padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,.2);animation:fu .3s ease;}
@keyframes fu{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes bn{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}
.ld{width:7px;height:7px;border-radius:50%;background:var(--acc);}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px;}
.ml{background:#fff;border-radius:20px;padding:24px;max-width:600px;width:100%;max-height:80vh;}
.prov-toggle{display:inline-flex;border-radius:10px;overflow:hidden;border:2px solid var(--bd2);background:#f8fafc;}
.prov-btn{padding:8px 18px;font-size:12px;font-weight:700;cursor:pointer;border:none;background:transparent;font-family:'Noto Sans KR',sans-serif;transition:all .15s;color:var(--tx2);}
.prov-btn.active-claude{background:#6366f1;color:#fff;}
.prov-btn.active-grok{background:#1a1a1a;color:#fff;}
.inp-tab{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Noto Sans KR',sans-serif;}
.inp-tab.on{background:var(--pri);color:#fff;}.inp-tab.off{background:#fff;color:var(--tx2);border:1.5px solid var(--bd2);}
.fetch-log{font-size:11px;color:var(--tx3);padding:4px 0;line-height:1.6;}.fetch-log b{color:var(--tx2);}
@media(max-width:899px){.do{display:none!important;}.sl{flex-direction:column!important;}.pn{max-height:none!important;}textarea{min-height:180px;}.sent{font-size:15px;}}
@media(min-width:900px){.mo-only{display:none!important;}.pn{max-height:calc(100vh - 56px);overflow-y:auto;}.pl{flex:1 1 46%;padding:24px 28px;}.pr{flex:1 1 54%;padding:24px 28px 24px 8px;}}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useCallback,useRef,useEffect}=React;

const API_KEYS={
  anthropic:"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",
  grok:"xai-Kyimh4NWfpS5M200mo7DriScIz0lQ88eWmbw5B4VPEuhFaVgk1ZvocFZqk0tFCAqZop55kPMHd9WwBef"
};
const MODELS={anthropic:"claude-sonnet-4-5-20250929",grok:"grok-4-1-fast-reasoning"};
const LABELS={anthropic:"ğŸŸ£ Claude Sonnet 4.5",grok:"âš« Grok 4.1 Fast ì¶”ë¡ "};

const CC={
"ì£¼ì ˆ":{bg:"#dbeafe",bd:"#3b82f6",tx:"#1e40af"},"ë“±ìœ„ì ˆ":{bg:"#dbeafe",bd:"#3b82f6",tx:"#1e40af"},
"ì¢…ì†ì ˆ":{bg:"#ede9fe",bd:"#8b5cf6",tx:"#5b21b6"},"ê´€ê³„ì ˆ":{bg:"#ede9fe",bd:"#8b5cf6",tx:"#5b21b6"},
"ëª…ì‚¬ì ˆ":{bg:"#cffafe",bd:"#06b6d4",tx:"#155e75"},"ë¶€ì‚¬ì ˆ":{bg:"#d1fae5",bd:"#10b981",tx:"#065f46"},
"í˜•ìš©ì‚¬ì ˆ":{bg:"#fef3c7",bd:"#f59e0b",tx:"#92400e"},"ì¡°ê±´ì ˆ":{bg:"#fee2e2",bd:"#ef4444",tx:"#991b1b"},
"ë¶„ì‚¬êµ¬ë¬¸":{bg:"#fce7f3",bd:"#ec4899",tx:"#9d174d"},"ë¶€ì •ì‚¬êµ¬":{bg:"#f3e8ff",bd:"#a855f7",tx:"#6b21a8"},
"ë™ëª…ì‚¬êµ¬":{bg:"#e0e7ff",bd:"#6366f1",tx:"#3730a3"},"ì „ì¹˜ì‚¬êµ¬":{bg:"#f1f5f9",bd:"#94a3b8",tx:"#475569"},
"ë™ê²©":{bg:"#f0fdf4",bd:"#22c55e",tx:"#166534"},"ì‚½ì…êµ¬":{bg:"#fefce8",bd:"#eab308",tx:"#854d0e"},
"ë³µí•©ìˆ ì–´":{bg:"#dbeafe",bd:"#3b82f6",tx:"#1e40af"},
};

function loadNB(){try{return JSON.parse(localStorage.getItem("eng-nb5"))||{v:[],g:[]};}catch{return{v:[],g:[]};}}
function saveNB(nb){localStorage.setItem("eng-nb5",JSON.stringify(nb));}

function robustParse(raw){
  let t=raw.replace(/```json\s*/gi,"").replace(/```/g,"").trim();
  let d=0,s=-1,e=-1;
  for(let i=0;i<t.length;i++){if(t[i]==="{"){if(!d)s=i;d++;}else if(t[i]==="}"){d--;if(!d){e=i;break;}}}
  if(s===-1||e===-1)throw new Error("JSON ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
  let j=t.slice(s,e+1);
  try{return JSON.parse(j);}catch{
    j=j.replace(/,\s*}/g,"}").replace(/,\s*]/g,"]").replace(/[\x00-\x1f]/g,m=>m==="\n"?"\\n":m==="\r"?"\\r":m==="\t"?"\\t":"");
    try{return JSON.parse(j);}catch(e2){throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: "+e2.message.slice(0,80));}
  }
}

async function callLLM(provider,systemPrompt,userContent,retries=2){
  const key=API_KEYS[provider];const model=MODELS[provider];let err="";
  for(let i=0;i<=retries;i++){
    try{
      let url,headers,body,extractText;
      if(provider==="anthropic"){
        url="https://api.anthropic.com/v1/messages";
        headers={"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"};
        const msgs=[{role:"user",content:typeof userContent==="string"?userContent:userContent}];
        body=systemPrompt?{model,max_tokens:4096,system:systemPrompt,messages:msgs}:{model,max_tokens:4096,messages:msgs};
        extractText=(d)=>(d.content||[]).filter(b=>b.type==="text").map(b=>b.text).join("");
      }else{
        url="https://api.x.ai/v1/chat/completions";
        headers={"Content-Type":"application/json","Authorization":"Bearer "+key};
        const msgs=[];if(systemPrompt)msgs.push({role:"system",content:systemPrompt});
        let userStr="";
        if(typeof userContent==="string")userStr=userContent;
        else if(Array.isArray(userContent))userStr=userContent.map(c=>c.text||"").join("\n\n");
        else userStr=String(userContent);
        msgs.push({role:"user",content:userStr});
        body={model,max_completion_tokens:4096,messages:msgs,temperature:0.3};
        extractText=(d)=>(d.choices&&d.choices[0])?d.choices[0].message?.content||"":"";
      }
      const r=await fetch(url,{method:"POST",headers,body:JSON.stringify(body)});
      if(!r.ok){const t=await r.text().catch(()=>"");err=`HTTP ${r.status}: ${t.slice(0,150)}`;if(i<retries){await new Promise(r=>setTimeout(r,2500));continue;}throw new Error(err);}
      const d=await r.json();if(d.error){err=d.error.message||JSON.stringify(d.error);throw new Error(err);}
      const txt=extractText(d);if(!txt.trim()){err="ë¹ˆ ì‘ë‹µ";if(i<retries){await new Promise(r=>setTimeout(r,2000));continue;}throw new Error(err);}
      return robustParse(txt);
    }catch(e){err=e.message;if(i<retries){await new Promise(r=>setTimeout(r,2500));continue;}throw new Error(err);}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL ì¶”ì¶œ â€” AI ë¯¸ì‚¬ìš©, ì§ì ‘ ì›¹ìŠ¤í¬ë˜í•‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// HTMLì—ì„œ ê¸°ì‚¬ ë³¸ë¬¸ ì¶”ì¶œ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ íŒŒì‹±)
function extractArticleFromHTML(html){
  const parser=new DOMParser();
  const doc=parser.parseFromString(html,"text/html");
  
  // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
  const removeSelectors=["script","style","nav","header","footer","aside","iframe",
    ".ad,.ads,.advertisement,.sidebar,.related,.comments,.social,.share,.newsletter",
    "[class*='nav']","[class*='menu']","[class*='footer']","[class*='sidebar']",
    "[class*='comment']","[class*='social']","[class*='share']","[class*='ad-']",
    "[id*='ad-']","[id*='comment']","[id*='sidebar']","figcaption","video","audio"];
  removeSelectors.forEach(sel=>{
    try{doc.querySelectorAll(sel).forEach(el=>el.remove());}catch{}
  });

  // ê¸°ì‚¬ ë³¸ë¬¸ ì°¾ê¸° (ìš°ì„ ìˆœìœ„)
  const articleSelectors=[
    "article","[class*='article-body']","[class*='article-content']","[class*='story-body']",
    "[class*='post-content']","[class*='entry-content']","[class*='content-body']",
    "[itemprop='articleBody']","[data-testid='article-body']",
    ".body-text",".article__body",".story-content","main"
  ];
  
  let articleEl=null;
  for(const sel of articleSelectors){
    try{
      const el=doc.querySelector(sel);
      if(el&&el.textContent.trim().length>300){articleEl=el;break;}
    }catch{}
  }

  // ì œëª© ì¶”ì¶œ
  let title="";
  const h1=doc.querySelector("h1");
  if(h1)title=h1.textContent.trim();
  else{const ogTitle=doc.querySelector('meta[property="og:title"]');if(ogTitle)title=ogTitle.getAttribute("content")||"";}

  // ë³¸ë¬¸ ì¶”ì¶œ
  let paragraphs=[];
  const source=articleEl||doc.body;
  source.querySelectorAll("p").forEach(p=>{
    const text=p.textContent.trim();
    // ê´‘ê³ /ì§§ì€ í…ìŠ¤íŠ¸/ë¹„ì˜ì–´ í•„í„°ë§
    if(text.length>30&&/[a-zA-Z]/.test(text)&&!/^(Share|Follow|Subscribe|Sign up|Â©|Copyright|Advertisement)/i.test(text)){
      paragraphs.push(text);
    }
  });

  if(paragraphs.length<2){
    // píƒœê·¸ê°€ ë¶€ì¡±í•˜ë©´ div ë‚´ í…ìŠ¤íŠ¸ë„ ì‹œë„
    source.querySelectorAll("div").forEach(div=>{
      if(div.children.length===0||div.childElementCount===0){
        const text=div.textContent.trim();
        if(text.length>50&&/[a-zA-Z]/.test(text))paragraphs.push(text);
      }
    });
  }

  if(!title&&paragraphs.length===0)return null;
  return(title?title+"\n\n":"")+paragraphs.join("\n\n");
}

// Jina Reader (ë¬´ë£Œ ì›¹ ë¦¬ë” ì„œë¹„ìŠ¤)
function cleanJinaText(raw){
  return raw
    .replace(/^Title:.*$/m,"").replace(/^URL Source:.*$/m,"")
    .replace(/^Markdown Content:?\s*/m,"").replace(/^Warning:.*$/gm,"")
    .replace(/\[([^\]]+)\]\([^)]+\)/g,"$1")  // markdown links
    .replace(/^#+\s*/gm,"")  // headers
    .replace(/\*\*/g,"")     // bold
    .replace(/!\[.*?\]\(.*?\)/g,"")  // images
    .replace(/^[-*]\s+/gm,"")  // bullets
    .replace(/\n{3,}/g,"\n\n")
    .trim();
}

async function fetchViaJina(url){
  const r=await fetch("https://r.jina.ai/"+url,{
    headers:{"Accept":"text/plain","X-Return-Format":"text","X-No-Cache":"true"}
  });
  if(!r.ok)throw new Error("Jina HTTP "+r.status);
  const text=await r.text();
  const cleaned=cleanJinaText(text);
  if(!cleaned||cleaned.length<200)throw new Error("ë‚´ìš© ë¶€ì¡± ("+cleaned.length+"ì)");
  return cleaned;
}

// CORS í”„ë¡ì‹œ + HTML íŒŒì‹±
async function fetchViaProxy(url){
  // ì—¬ëŸ¬ CORS í”„ë¡ì‹œ ì‹œë„
  const proxies=[
    u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
    u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  ];
  for(const mkUrl of proxies){
    try{
      const r=await fetch(mkUrl(url),{signal:AbortSignal.timeout(15000)});
      if(!r.ok)continue;
      const html=await r.text();
      if(!html||html.length<500)continue;
      const article=extractArticleFromHTML(html);
      if(article&&article.length>200)return article;
    }catch{continue;}
  }
  throw new Error("ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨");
}

// í†µí•© URL ì¶”ì¶œ
async function fetchUrl(url,setLog){
  // 1) Jina Reader
  setLog("â‘  Jina Readerë¡œ ê¸°ì‚¬ ì¶”ì¶œ ì¤‘...");
  try{const t=await fetchViaJina(url);setLog("âœ… Jina Reader ì„±ê³µ! ("+t.length+"ì)");return t;}
  catch(e){setLog("â‘  Jina ì‹¤íŒ¨ ("+e.message+"). í”„ë¡ì‹œë¡œ ì „í™˜...");}

  // 2) CORS í”„ë¡ì‹œ + HTML íŒŒì‹±
  setLog("â‘¡ CORS í”„ë¡ì‹œë¡œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°...");
  try{const t=await fetchViaProxy(url);setLog("âœ… í”„ë¡ì‹œ ì¶”ì¶œ ì„±ê³µ! ("+t.length+"ì)");return t;}
  catch(e){setLog("â‘¡ í”„ë¡ì‹œë„ ì‹¤íŒ¨ ("+e.message+")");}

  setLog("âŒ ìë™ ì¶”ì¶œ ì‹¤íŒ¨ â€” ê¸°ì‚¬ ì›ë¬¸ì„ ì§ì ‘ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.");
  throw new Error("URLì—ì„œ ê¸°ì‚¬ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ê¸°ì‚¬ í˜ì´ì§€ì—ì„œ Ctrl+A â†’ Ctrl+C ë¡œ ì „ì²´ ë³µì‚¬\n2. ì•„ë˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— Ctrl+V ë¡œ ë¶™ì—¬ë„£ê¸°");
}

// â”€â”€â”€ Prompts â”€â”€â”€
const ART_PROMPT=`You are an expert English teacher for Korean learners. Analyze this article structure.
Return ONLY a JSON object (no markdown, no extra text):
{"article_topic":"ê¸°ì‚¬ ì£¼ì œ (í•œêµ­ì–´ 1ë¬¸ì¥)","paragraphs":[{"main_idea":"ì¤‘ì‹¬ë‚´ìš© (í•œêµ­ì–´ 1ë¬¸ì¥)","role":"ë„ì…/ì£¼ì¥/ê·¼ê±°/ì¸ìš©/ê²°ë¡ /ë°°ê²½ì„¤ëª…","sentences":["exact sentence 1","exact sentence 2"]}]}
Rules: Keep EVERY sentence exactly as original. Split quoted speech into separate sentences. Escape quotes. Every paragraph must appear.`;

const SENT_PROMPT=`You are an expert English grammar teacher for Korean learners.
Return ONLY a JSON object (no markdown):
{"translation":"í•œêµ­ì–´ ì „ì²´ ë²ˆì—­","sentence_type":"ë‹¨ë¬¸/ì¤‘ë¬¸/ë³µë¬¸/í˜¼í•©ë¬¸","sentence_type_explanation":"ì´ìœ  í•œêµ­ì–´ 1ë¬¸ì¥","reading_guide":{"chunks":[{"en":"ì˜ì–´ ë©ì–´ë¦¬","ko":"í•œêµ­ì–´","connector_note":"ë‹¤ìŒ ë©ì–´ë¦¬ë¡œ ì´ì–´ì§€ëŠ” ë°©ë²• or null"}],"full_flow":"ëŠì–´ì½ê¸°ë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì´ì–´ë¶™ì¸ ì „ì²´ í•´ì„","reading_order":"í•´ì„ ìˆœì„œ ì•ˆë‚´ 2-3ë¬¸ì¥"},"connectors":[{"text":"ì—°ê²°í‘œí˜„","position":"ì•ë’¤ ë¬¸ë§¥","type":"ë“±ìœ„ì ‘ì†/ê´€ê³„ëŒ€ëª…ì‚¬(ê³„ì†ì )/ë¶€ì‚¬ì ˆì ‘ì†ì‚¬/ë¶„ì‚¬êµ¬ë¬¸/ë™ê²©/ì‚½ì…êµ¬ ë“±","how_to_read":"í•´ì„ë²• 2-3ë¬¸ì¥","common_pattern":"ë‰´ìŠ¤ìš©ë²• 1ë¬¸ì¥"}],"clauses":[{"text":"ì ˆ ì›ë¬¸","type":"ì£¼ì ˆ/ë“±ìœ„ì ˆ/ì¢…ì†ì ˆ/ê´€ê³„ì ˆ/ëª…ì‚¬ì ˆ/ë¶€ì‚¬ì ˆ/í˜•ìš©ì‚¬ì ˆ/ì¡°ê±´ì ˆ/ë¶„ì‚¬êµ¬ë¬¸/ë¶€ì •ì‚¬êµ¬/ë™ëª…ì‚¬êµ¬/ì „ì¹˜ì‚¬êµ¬/ë™ê²©/ì‚½ì…êµ¬","translation":"í•œêµ­ì–´ ë²ˆì—­","function":"ì—­í• ","subject":"ì£¼ì–´ or null","verb":"ë™ì‚¬ or null","connector":"ì ‘ì†ì‚¬ or null"}],"grammar_points":[{"point":"ë¬¸ë²•ëª…","category":"í’ˆì‚¬/ë¬¸ì¥êµ¬ì¡°/ì‹œì œ/ì¤€ë™ì‚¬/íŠ¹ìˆ˜êµ¬ë¬¸/ê¸°íƒ€","explanation":"ì„¤ëª… 2-3ë¬¸ì¥","highlight":"í•´ë‹¹ ì›ë¬¸","example_translation":"highlightì˜ í•œêµ­ì–´ í•´ì„"}],"vocabulary":[{"word":"ì˜ë‹¨ì–´","meaning":"í•œêµ­ì–´","pos":"noun/verb/adj/adv/phrase/idiom","context_note":"ë‰´ìŠ¤ìš©ë²• 1ë¬¸ì¥"}]}
RULES: chunks 3-8ê°œ ì „ì²´ì»¤ë²„+connector_note. full_flow=ë¶€ë“œëŸ¬ìš´ ì „ì²´í•´ì„. connectors=ALLì—°ê²°ì (ë™ê²©/ì‚½ì…êµ¬ í¬í•¨). clauses=ì „ì²´ì»¤ë²„+ê°ê°translation. grammar=ê°ê°example_translationí•„ìˆ˜. 2-4 grammar, 3-5 vocab.`;

async function analyzeArticle(prov,text){
  return await callLLM(prov,null,[{type:"text",text:ART_PROMPT+"\n\nArticle:"},{type:"text",text:text}]);
}
async function analyzeSent(prov,sent){
  return await callLLM(prov,null,[{type:"text",text:SENT_PROMPT+"\n\nSentence:"},{type:"text",text:sent}]);
}

// â”€â”€â”€ Components â”€â”€â”€
function Dots({label}){return<div className="flex ai g2" style={{padding:"16px 0",flexWrap:"wrap"}}>{[0,1,2].map(i=><div key={i} className="ld" style={{animation:`bn 1.2s ease-in-out ${i*.15}s infinite`}}/>)}<span style={{fontSize:13,color:"var(--tx3)"}}>{label}</span></div>;}
function Chip({type}){const c=CC[type]||{bg:"#f1f5f9",bd:"#94a3b8",tx:"#475569"};return<span className="chip" style={{background:c.bg,color:c.tx,border:`1px solid ${c.bd}40`}}>{type}</span>;}
function Sec({icon,title,color,children,dOpen=true}){const[o,setO]=useState(dOpen);return<div className="card"><div className="sh flex ai jb" onClick={()=>setO(!o)}><div style={{fontSize:11,fontWeight:700,color:color||"var(--acc)",letterSpacing:1.2}}>{icon} {title}</div><span style={{fontSize:12,color:"var(--tx3)",transform:o?"rotate(180deg)":"rotate(0)",transition:"transform .2s"}}>â–¼</span></div>{o&&<div className="sb">{children}</div>}</div>;}
function ProvToggle({prov,setProv}){return<div className="prov-toggle"><button className={`prov-btn ${prov==="anthropic"?"active-claude":""}`} onClick={()=>setProv("anthropic")}>ğŸŸ£ Claude</button><button className={`prov-btn ${prov==="grok"?"active-grok":""}`} onClick={()=>setProv("grok")}>âš« Grok</button></div>;}

function ExportModal({nb,onClose}){
  const[tab,setTab]=useState("csv");const ref=useRef(null);
  let c="";
  if(tab==="csv"){c="\uFEFFìœ í˜•,ì˜ì–´,í•œêµ­ì–´,í’ˆì‚¬/ì¹´í…Œê³ ë¦¬,ë©”ëª¨\n";nb.v.forEach(v=>c+=`ì–´íœ˜,"${(v.word||"").replace(/"/g,'""')}","${(v.meaning||"").replace(/"/g,'""')}","${v.pos||""}","${(v.context_note||"").replace(/"/g,'""')}"\n`);nb.g.forEach(g=>c+=`ë¬¸ë²•,"${(g.point||"").replace(/"/g,'""')}","${(g.explanation||"").slice(0,60).replace(/"/g,'""')}","${g.category||""}","${(g.highlight||"").replace(/"/g,'""')}"\n`);}
  else{nb.v.forEach(v=>c+=`${v.word}\t${v.meaning} (${v.pos})${v.context_note?" - "+v.context_note:""}\n`);nb.g.forEach(g=>c+=`${g.point} (${g.category})\t${g.explanation||""}${g.highlight?" ì˜ˆ: "+g.highlight:""}\n`);}
  const copy=()=>{navigator.clipboard.writeText(c).then(()=>alert("âœ… ë³µì‚¬ë¨!")).catch(()=>{if(ref.current){ref.current.select();document.execCommand("copy");alert("âœ… ë³µì‚¬ë¨!");}});};
  const dl=()=>{try{const b=new Blob([c],{type:tab==="csv"?"text/csv;charset=utf-8;":"text/plain;charset=utf-8;"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=tab==="csv"?"notebook.csv":"notebook-anki.txt";document.body.appendChild(a);a.click();document.body.removeChild(a);}catch{alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");}};
  return<div className="mo" onClick={onClose}><div className="ml flex fc g3" onClick={e=>e.stopPropagation()}>
    <div className="flex jb ai"><h2 style={{fontSize:18,fontWeight:700}}>ğŸ“¥ ë‚´ë³´ë‚´ê¸°</h2><button onClick={onClose} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:"var(--tx3)"}}>âœ•</button></div>
    <div className="flex g2">{[["csv","CSV (ì—‘ì…€)"],["anki","Anki"]].map(([k,l])=><button key={k} onClick={()=>setTab(k)} className="btn" style={{background:tab===k?"var(--pri)":"#f1f5f9",color:tab===k?"#fff":"var(--tx2)"}}>{l}</button>)}</div>
    <textarea ref={ref} value={c} readOnly style={{height:200,fontFamily:"monospace",fontSize:12,minHeight:150}}/>
    <div className="flex g2"><button onClick={copy} className="btn bp" style={{flex:1,padding:12,fontSize:14}}>ğŸ“‹ ë³µì‚¬</button><button onClick={dl} className="btn" style={{flex:1,padding:12,fontSize:14,background:"var(--grn)",color:"#fff",border:"none"}}>ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button></div>
  </div></div>;
}

function NoteView({onBack,nb,setNB}){
  const[tab,setTab]=useState("v");const[exp,setExp]=useState(false);
  const rm=(t,i)=>{const u={...nb,[t]:nb[t].filter((_,j)=>j!==i)};setNB(u);saveNB(u);};
  const cl=(t)=>{if(!confirm("ì •ë§ ì „ì²´ ì‚­ì œ?"))return;const u={...nb,[t]:[]};setNB(u);saveNB(u);};
  return<div style={{minHeight:"100vh"}}>
    {exp&&<ExportModal nb={nb} onClose={()=>setExp(false)}/>}
    <div className="hdr flex ai jb fw g2">
      <div className="flex ai g2"><span style={{fontSize:22}}>ğŸ“’</span><div><h1 style={{fontSize:16,fontWeight:700}}>ë‚˜ì˜ ë‹¨ì–´ì¥</h1><p style={{fontSize:11,color:"var(--tx3)"}}>ì–´íœ˜ {nb.v.length}ê°œ Â· ë¬¸ë²• {nb.g.length}ê°œ</p></div></div>
      <div className="flex g2 fw"><button onClick={()=>setExp(true)} className="btn bg-btn">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button><button onClick={onBack} className="btn bo">â† ë¶„ì„ê¸°ë¡œ</button></div>
    </div>
    <div style={{maxWidth:800,margin:"0 auto",padding:"20px 16px"}}>
      <div className="flex g2" style={{marginBottom:16}}>{[["v","ğŸ“š ì–´íœ˜",nb.v.length],["g","ğŸ“ ë¬¸ë²•",nb.g.length]].map(([k,l,c])=><button key={k} onClick={()=>setTab(k)} className="btn" style={{padding:"10px 20px",borderRadius:10,background:tab===k?"var(--pri)":"#fff",color:tab===k?"#fff":"var(--tx2)",border:tab===k?"none":"1.5px solid var(--bd2)",fontSize:14}}>{l} ({c})</button>)}</div>
      {tab==="v"?(nb.v.length===0?<p className="tc" style={{color:"var(--tx3)",padding:40}}>â­ ë²„íŠ¼ìœ¼ë¡œ ì–´íœ˜ë¥¼ ì €ì¥í•˜ì„¸ìš”</p>:
        <div className="flex fc g2">{nb.v.map((v,i)=><div key={i} className="card flex g3" style={{padding:"12px 16px"}}><div style={{flex:1}}><span className="nf" style={{fontSize:16,fontWeight:700}}>{v.word}</span> <span style={{fontSize:10,color:"var(--tx3)",fontStyle:"italic"}}>{v.pos}</span><div style={{fontSize:14,fontWeight:600,marginTop:2}}>{v.meaning}</div>{v.context_note&&<div style={{fontSize:12,color:"var(--tx2)",marginTop:2}}>{v.context_note}</div>}</div><button onClick={()=>rm("v",i)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:"#cbd5e1"}}>âœ•</button></div>)}<button onClick={()=>cl("v")} className="btn br" style={{alignSelf:"flex-end",marginTop:8}}>ì „ì²´ ì‚­ì œ</button></div>)
      :(nb.g.length===0?<p className="tc" style={{color:"var(--tx3)",padding:40}}>â­ ë²„íŠ¼ìœ¼ë¡œ ë¬¸ë²•ì„ ì €ì¥í•˜ì„¸ìš”</p>:
        <div className="flex fc g2">{nb.g.map((g,i)=><div key={i} className="card flex g3" style={{padding:"12px 16px"}}><div style={{flex:1}}><span style={{fontSize:14,fontWeight:700}}>{g.point}</span> <span className="tag tr">{g.category}</span><div style={{fontSize:13,color:"var(--tx2)",marginTop:4,lineHeight:1.6}}>{g.explanation}</div>{g.highlight&&<code style={{fontSize:12,background:"#e0e7ff",color:"#3730a3",padding:"2px 8px",borderRadius:4}}>"{g.highlight}"</code>}{g.example_translation&&<div style={{fontSize:12,color:"var(--pri)",marginTop:2,fontWeight:600}}>â†’ {g.example_translation}</div>}</div><button onClick={()=>rm("g",i)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:"#cbd5e1"}}>âœ•</button></div>)}<button onClick={()=>cl("g")} className="btn br" style={{alignSelf:"flex-end",marginTop:8}}>ì „ì²´ ì‚­ì œ</button></div>)}
    </div>
  </div>;
}

function App(){
  const[prov,setProv]=useState(()=>localStorage.getItem("eng-prov")||"anthropic");
  const[article,setArt]=useState("");
  const[artUrl,setUrl]=useState("");
  const[inpMode,setInp]=useState("text");
  const[urlLoad,setUL]=useState(false);
  const[fetchLog,setFL]=useState("");
  const[mode,setMode]=useState("edit");
  const[ov,setOv]=useState(null);const[ovL,setOvL]=useState(false);const[ovE,setOvE]=useState(null);
  const[flat,setFlat]=useState([]);const[sel,setSel]=useState(null);const[cache,setCache]=useState({});
  const[sL,setSL]=useState(false);const[hov,setHov]=useState(null);
  const[nb,setNB]=useState(loadNB());const[toast,setToast]=useState(null);
  const pRef=useRef(null);

  const changeProv=(p)=>{setProv(p);localStorage.setItem("eng-prov",p);};
  const flash=m=>{setToast(m);setTimeout(()=>setToast(null),2000);};
  const savV=(v,src)=>{if(nb.v.some(e=>e.word===v.word)){flash("ì´ë¯¸ ì €ì¥ë¨");return;}const u={...nb,v:[...nb.v,{...v,source:src}]};setNB(u);saveNB(u);flash(`â­ "${v.word}" ì €ì¥!`);};
  const savG=(g,src)=>{if(nb.g.some(e=>e.point===g.point&&e.highlight===g.highlight)){flash("ì´ë¯¸ ì €ì¥ë¨");return;}const u={...nb,g:[...nb.g,{...g,source:src}]};setNB(u);saveNB(u);flash(`â­ "${g.point}" ì €ì¥!`);};

  const doFetchUrl=useCallback(async()=>{
    if(!artUrl.trim())return;setUL(true);setFL("");
    try{
      const t=await fetchUrl(artUrl.trim(),setFL);
      setArt(t);setInp("text");
      setFL(prev=>prev+"\nâ†’ í…ìŠ¤íŠ¸ ì˜ì—­ì— ë°˜ì˜ë¨! ë¶„ì„ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    }catch(e){
      setFL(e.message);
    }
    setUL(false);
  },[artUrl]);

  const doAnalyze=useCallback(async()=>{
    if(!article.trim())return;setMode("read");setOvL(true);setOv(null);setOvE(null);setFlat([]);setSel(null);setCache({});
    try{
      const r=await analyzeArticle(prov,article);
      if(!r.paragraphs?.length)throw new Error("ë‹¨ë½ ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
      setOv(r);const f=[];r.paragraphs.forEach((p,pi)=>(p.sentences||[]).forEach((s,si)=>f.push({text:s,pIdx:pi,sIdx:si,key:`${pi}-${si}`,para:p})));setFlat(f);
    }catch(e){setOv(null);setOvE(e.message);}
    setOvL(false);
  },[article,prov]);

  const doSent=useCallback(async(key,text)=>{
    setSel(key);if(cache[key])return;setSL(true);
    try{const r=await analyzeSent(prov,text);setCache(p=>({...p,[key]:r}));}
    catch(e){setCache(p=>({...p,[key]:{error:true,errorMsg:e.message}}));}
    setSL(false);
  },[cache,prov]);

  useEffect(()=>{if(sel&&pRef.current)pRef.current.scrollTo({top:0,behavior:"smooth"});},[sel]);

  const cur=sel?cache[sel]:null;const sf=sel?flat.find(f=>f.key===sel):null;const src=sf?.text?.slice(0,40)+"...";

  if(mode==="notebook")return<NoteView onBack={()=>setMode("read")} nb={nb} setNB={setNB}/>;

  if(mode==="edit")return<div className="flex fc ai jc" style={{minHeight:"100vh",padding:24}}>
    <div style={{maxWidth:720,width:"100%"}}>
      <h1 style={{fontSize:26,fontWeight:700,marginBottom:8}}>ğŸ“° ì˜ë¬¸ ë¶„ì„ê¸°</h1>
      <p style={{fontSize:13,color:"var(--tx2)",marginBottom:16,lineHeight:1.7}}>ì˜ì–´ ê¸°ì‚¬ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ URLì„ ì…ë ¥í•˜ë©´ AIê°€ <b style={{color:"var(--pri)"}}>ë‹¨ë½â†’ëŠì–´ì½ê¸°â†’ì—°ê²°ì–´â†’ì ˆ êµ¬ë¶„â†’ë¬¸ë²•â†’ì–´íœ˜</b> ìˆœì„œë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
      <div className="flex ai jb fw g2" style={{marginBottom:14}}>
        <div className="flex ai g2"><ProvToggle prov={prov} setProv={changeProv}/><span style={{fontSize:11,color:"var(--tx3)"}}>{LABELS[prov]}</span></div>
        <button onClick={()=>setMode("notebook")} className="btn ba">ğŸ“’ ë‹¨ì–´ì¥ ({nb.v.length+nb.g.length})</button>
      </div>
      <div className="flex g2" style={{marginBottom:12}}>
        {[["text","ğŸ“ ì§ì ‘ ì…ë ¥"],["url","ğŸ”— URL ì…ë ¥"]].map(([k,l])=>
          <button key={k} onClick={()=>setInp(k)} className={`inp-tab ${inpMode===k?"on":"off"}`}>{l}</button>
        )}
      </div>
      {inpMode==="url"&&<div style={{marginBottom:16}}>
        <div className="flex g2 fw">
          <input type="text" value={artUrl} onChange={e=>setUrl(e.target.value)} placeholder="https://www.foxnews.com/..." style={{flex:1,minWidth:200}} onKeyDown={e=>e.key==="Enter"&&doFetchUrl()}/>
          <button onClick={doFetchUrl} disabled={urlLoad||!artUrl.trim()} className="btn bp" style={{padding:"12px 20px",fontSize:14,whiteSpace:"nowrap",opacity:urlLoad?0.6:1}}>{urlLoad?"ì¶”ì¶œ ì¤‘...":"ê°€ì ¸ì˜¤ê¸°"}</button>
        </div>
        {urlLoad&&<Dots label="ê¸°ì‚¬ ë³¸ë¬¸ ì¶”ì¶œ ì¤‘..."/>}
        {fetchLog&&<div className="fetch-log" style={{whiteSpace:"pre-line"}}>{fetchLog}</div>}
        <p style={{fontSize:11,color:"var(--tx3)",marginTop:6}}>ğŸ’¡ Jina Reader â†’ CORS í”„ë¡ì‹œ ìˆœì„œë¡œ ì‹œë„í•©ë‹ˆë‹¤ (AI ë¯¸ì‚¬ìš©). ì‹¤íŒ¨ ì‹œ ê¸°ì‚¬ë¥¼ ì§ì ‘ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.</p>
      </div>}
      <textarea value={article} onChange={e=>setArt(e.target.value)} placeholder="ì˜ì–´ ê¸°ì‚¬ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;ğŸ’¡ íŒ: ê¸°ì‚¬ ì›ë¬¸ì„ ì§ì ‘ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•˜ë©´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤."/>
      <button onClick={doAnalyze} disabled={!article.trim()} className="bbig w100" style={{marginTop:14}}>
        {prov==="anthropic"?"ğŸŸ£":"âš«"} {LABELS[prov]}ë¡œ ë¶„ì„ ì‹œì‘ â†’
      </button>
    </div>
  </div>;

  const provColor=prov==="anthropic"?"#6366f1":"#1a1a1a";
  const artP=<div className="pn pl" style={{padding:16}}>
    {ov?.article_topic&&<div style={{background:`linear-gradient(135deg,${provColor},${provColor}cc)`,borderRadius:14,padding:"14px 20px",marginBottom:16,color:"#fff"}}><div style={{fontSize:10,fontWeight:700,letterSpacing:1.5,opacity:.7,marginBottom:3}}>ğŸ“Œ ê¸°ì‚¬ ì£¼ì œ</div><p style={{fontSize:14,fontWeight:600,lineHeight:1.5}}>{ov.article_topic}</p></div>}
    {ov?.paragraphs?.map((p,pi)=><div key={pi} className="card" style={{padding:"18px 22px",marginBottom:12}}>
      <div className="flex ai g2 fw" style={{marginBottom:6}}><span className="tag tp">P{pi+1}</span><span className="tag tr">{p.role}</span><span style={{fontSize:11,color:"var(--tx3)"}}>â€” {p.main_idea}</span></div>
      <div className="nf" style={{lineHeight:2.2,marginTop:6}}>{p.sentences?.map((s,si)=>{const k=`${pi}-${si}`,iS=k===sel,hC=!!cache[k];return<span key={k} className={`sent nf ${iS?"act":""}`} onClick={()=>doSent(k,s)} onMouseEnter={()=>setHov(k)} onMouseLeave={()=>setHov(null)}>{s}{" "}{hC&&!iS&&<span className="dot"/>}</span>;})}</div>
    </div>)}
  </div>;

  const anaP=<div ref={pRef} className="pn pr" style={{padding:16}}>
    {!sel?<div className="flex fc ai jc" style={{height:"60vh",gap:10}}><div style={{fontSize:44,opacity:.25}}>ğŸ‘†</div><p style={{fontSize:15,color:"var(--tx3)",lineHeight:1.8}}>ì™¼ìª½ ê¸°ì‚¬ì—ì„œ <b style={{color:"var(--pri)"}}>ë¬¸ì¥ì„ í´ë¦­</b>í•˜ì„¸ìš”</p></div>
    :sL&&!cur?<Dots label={`${LABELS[prov]}ë¡œ ë¶„ì„ ì¤‘...`}/>
    :cur?.error?<div className="card tc" style={{padding:24,background:"#fef2f2",border:"1px solid #fecaca"}}><p style={{color:"#dc2626",fontWeight:600,marginBottom:4}}>ë¶„ì„ ì˜¤ë¥˜</p>{cur.errorMsg&&<p style={{color:"#f87171",fontSize:12,marginBottom:12,wordBreak:"break-all"}}>{cur.errorMsg}</p>}<button onClick={()=>{setCache(p=>{const n={...p};delete n[sel];return n;});if(sf)doSent(sel,sf.text);}} className="btn" style={{background:"#dc2626",color:"#fff",border:"none"}}>ğŸ”„ ë‹¤ì‹œ ì‹œë„</button></div>
    :cur?<div className="flex fc g3">
      <div className="card" style={{padding:"14px 18px"}}><div className="flex ai g1 fw" style={{marginBottom:6}}><span className="tag tp">P{(sf?.pIdx??0)+1}</span><span className="tag ts">S{(sf?.sIdx??0)+1}</span><span className="tag tt">{cur.sentence_type}</span><span style={{fontSize:11,color:"var(--tx3)"}}>{cur.sentence_type_explanation}</span></div><p className="nf" style={{fontSize:16,lineHeight:1.9,fontWeight:500}}>{sf?.text}</p></div>
      <Sec icon="ğŸ‡°ğŸ‡·" title="ì „ì²´ í•´ì„" color="var(--acc)"><p style={{fontSize:15,lineHeight:1.8,fontWeight:500}}>{cur.translation}</p></Sec>
      {cur.reading_guide?.chunks?.length>0&&<Sec icon="âœ‚ï¸" title="ëŠì–´ ì½ê¸° ê°€ì´ë“œ" color="var(--red)">
        <div style={{marginBottom:10}}>{cur.reading_guide.chunks.map((ch,i)=><div key={i}><div style={{padding:"8px 12px",borderLeft:"3px solid var(--red)",background:i%2===0?"#fff5f7":"#fff"}}><p className="nf" style={{fontSize:14.5,fontWeight:500,lineHeight:1.6}}>{ch.en}</p><p style={{fontSize:13,color:"#9f1239",marginTop:2,fontWeight:500}}>{ch.ko}</p></div>{ch.connector_note&&i<cur.reading_guide.chunks.length-1&&<div className="cn">â†³ {ch.connector_note}</div>}</div>)}</div>
        {cur.reading_guide.full_flow&&<div className="fb" style={{marginBottom:10}}><div style={{fontSize:10,fontWeight:700,color:"var(--red)",letterSpacing:1,marginBottom:4}}>ğŸ“– ì´ì–´ì„œ ì½ê¸°</div><p style={{fontSize:14,lineHeight:1.8,fontWeight:500}}>{cur.reading_guide.full_flow}</p></div>}
        <div className="tb"><p style={{fontSize:12.5,color:"var(--tx2)",lineHeight:1.7}}>ğŸ’¡ {cur.reading_guide.reading_order}</p></div>
      </Sec>}
      {cur.connectors?.length>0&&<Sec icon="ğŸ”—" title="ì—°ê²°ì–´ í•´ì„ë²•" color="var(--amb)">
        <div className="flex fc" style={{gap:10}}>{cur.connectors.map((cn,i)=><div key={i} className="cc">
          <div className="flex ai g2 fw" style={{marginBottom:6}}><span className="nf" style={{fontSize:14,fontWeight:800,color:"#92400e",background:"#fef3c7",padding:"2px 10px",borderRadius:6}}>{cn.text}</span><span style={{fontSize:10,fontWeight:600,color:"var(--amb)",background:"rgba(253,230,138,.4)",borderRadius:14,padding:"2px 9px"}}>{cn.type}</span></div>
          <p className="nf" style={{fontSize:13,color:"#78716c",fontStyle:"italic",marginBottom:8}}>...{cn.position}...</p>
          <div style={{background:"#fff",borderRadius:8,padding:"10px 12px",border:"1px solid rgba(253,230,138,.5)",marginBottom:4}}><p style={{fontSize:13,color:"#44403c",lineHeight:1.7,fontWeight:500}}>ğŸ’¡ {cn.how_to_read}</p></div>
          {cn.common_pattern&&<p style={{fontSize:11,color:"#a8a29e",fontStyle:"italic"}}>ğŸ“ {cn.common_pattern}</p>}
        </div>)}</div>
      </Sec>}
      <Sec icon="ğŸ”" title="ì ˆÂ·êµ¬ ë¶„ì„" color="var(--pur)">
        <div className="flex fc" style={{gap:8}}>{cur.clauses?.map((c,i)=>{const cl=CC[c.type]||{bg:"#f1f5f9",bd:"#94a3b8",tx:"#475569"};return<div key={i} style={{background:cl.bg+"90",border:`1.5px solid ${cl.bd}50`,borderLeft:`4px solid ${cl.bd}`,borderRadius:10,padding:"11px 14px"}}>
          <div className="flex ai g2 fw" style={{marginBottom:5}}><Chip type={c.type}/>{c.connector&&<span style={{fontSize:11,color:"var(--tx2)",fontStyle:"italic"}}>ì—°ê²°ì–´: {c.connector}</span>}</div>
          <p className="nf" style={{fontSize:14,lineHeight:1.7,fontWeight:500,marginBottom:4}}>"{c.text}"</p>
          {c.translation&&<p style={{fontSize:13,color:cl.tx,fontWeight:600,background:cl.bg+"60",padding:"4px 10px",borderRadius:6,display:"inline-block",marginBottom:6}}>â†’ {c.translation}</p>}
          <p style={{fontSize:12,color:"var(--tx2)",lineHeight:1.5}}>{c.subject&&<span>ì£¼ì–´: <b>{c.subject}</b> Â· </span>}{c.verb&&<span>ë™ì‚¬: <b>{c.verb}</b> Â· </span>}{c.function}</p>
        </div>;})}</div>
      </Sec>
      {cur.grammar_points?.length>0&&<Sec icon="ğŸ“" title="ë¬¸ë²• í¬ì¸íŠ¸" color="var(--acc)">
        <div className="flex fc" style={{gap:10}}>{cur.grammar_points.map((g,i)=><div key={i} style={{padding:"12px 14px",background:"#f8fafc",borderRadius:10,borderLeft:"4px solid var(--acc)",position:"relative"}}>
          <button onClick={()=>savG(g,src)} style={{position:"absolute",top:10,right:10,background:"none",border:"none",fontSize:18,cursor:"pointer",color:nb.g.some(e=>e.point===g.point&&e.highlight===g.highlight)?"#f59e0b":"#cbd5e1"}}>â­</button>
          <div className="flex ai g2" style={{marginBottom:5,paddingRight:30}}><span style={{fontSize:13.5,fontWeight:700}}>{g.point}</span><span className="tag tr">{g.category}</span></div>
          <p style={{fontSize:12.5,color:"var(--tx2)",lineHeight:1.7,marginBottom:5}}>{g.explanation}</p>
          {g.highlight&&<div style={{marginTop:6}}><code className="nf" style={{fontSize:12.5,padding:"3px 9px",borderRadius:6,background:"#e0e7ff",color:"#3730a3",fontStyle:"italic"}}>"{g.highlight}"</code>{g.example_translation&&<p style={{fontSize:12.5,color:"var(--pri)",margin:"4px 0 0 4px",fontWeight:600}}>â†’ {g.example_translation}</p>}</div>}
        </div>)}</div>
      </Sec>}
      {cur.vocabulary?.length>0&&<Sec icon="ğŸ“š" title="ì£¼ìš” ì–´íœ˜" color="var(--grn)">
        <div className="flex fc">{cur.vocabulary.map((v,i)=><div key={i} className="flex" style={{gap:10,padding:"9px 12px",borderRadius:8,background:i%2===0?"#f8fafc":"transparent",alignItems:"flex-start"}}>
          <button onClick={()=>savV(v,src)} style={{background:"none",border:"none",fontSize:16,cursor:"pointer",color:nb.v.some(e=>e.word===v.word)?"#f59e0b":"#cbd5e1",flexShrink:0,paddingTop:2}}>â­</button>
          <div style={{minWidth:120}}><span className="nf" style={{fontSize:14.5,fontWeight:700}}>{v.word}</span><span style={{fontSize:10,color:"var(--tx3)",marginLeft:5,fontStyle:"italic"}}>{v.pos}</span></div>
          <div style={{flex:1}}><div style={{fontSize:13,fontWeight:600}}>{v.meaning}</div>{v.context_note&&<div style={{fontSize:11.5,color:"var(--tx2)",marginTop:2,lineHeight:1.5}}>{v.context_note}</div>}</div>
        </div>)}</div>
      </Sec>}
    </div>:null}
  </div>;

  return<div style={{minHeight:"100vh"}}>
    <div className="hdr flex ai jb fw g2">
      <div className="flex ai g2"><span style={{fontSize:20}}>ğŸ“°</span><div><h1 style={{fontSize:15,fontWeight:700}}>ì˜ë¬¸ ë¶„ì„ê¸°</h1><p style={{fontSize:10,color:"var(--tx3)"}}>ë¬¸ì¥ í´ë¦­ â†’ ëŠì–´ì½ê¸° Â· ì—°ê²°ì–´ Â· ì ˆë¶„ì„ Â· ë¬¸ë²• Â· ì–´íœ˜</p></div></div>
      <div className="flex ai g2 fw">
        <ProvToggle prov={prov} setProv={p=>{changeProv(p);flash(`${LABELS[p]}ë¡œ ì „í™˜`);}}/>
        <button onClick={()=>setMode("notebook")} className="btn ba">ğŸ“’ ({nb.v.length+nb.g.length})</button>
        <button onClick={()=>{setMode("edit");setSel(null);}} className="btn bo">âœï¸ ê¸°ì‚¬ ë³€ê²½</button>
      </div>
    </div>
    {toast&&<div className="toast">{toast}</div>}
    {ovL?<div className="flex ai jc" style={{height:"70vh"}}><Dots label={`${LABELS[prov]}ë¡œ ê¸°ì‚¬ êµ¬ì¡° ë¶„ì„ ì¤‘...`}/></div>
    :ovE||!ov?<div className="flex fc ai jc" style={{height:"70vh",gap:12,padding:20}}>
      <p style={{color:"#dc2626",fontWeight:600,fontSize:16}}>ë¶„ì„ ì‹¤íŒ¨</p>
      {ovE&&<div style={{background:"#fef2f2",borderRadius:10,padding:"12px 18px",border:"1px solid #fecaca",maxWidth:500,width:"100%"}}><p style={{color:"#f87171",fontSize:13,wordBreak:"break-all"}}>{ovE}</p></div>}
      <div className="flex g2" style={{marginTop:8}}><button onClick={doAnalyze} className="btn bp" style={{padding:"10px 24px",fontSize:14}}>ğŸ”„ ë‹¤ì‹œ ì‹œë„</button><button onClick={()=>setMode("edit")} className="btn bo" style={{padding:"10px 24px",fontSize:14}}>âœï¸ ìˆ˜ì •</button></div>
    </div>
    :<div className="flex sl" style={{maxWidth:1440,margin:"0 auto",minHeight:"calc(100vh - 56px)"}}>{artP}{anaP}</div>}
  </div>;
}

ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
</script>
</body>
</html>
